#
# Rules.make: common makefile rules for the dtn project.
#

#
# Targets are "native" and "arm"
# 
TARGET 		= @TARGET@

#
# Common settings extracted from the configure script
#
CC		= @CC@
CXX		= @CXX@
DEPFLAGS	= @DEPFLAGS@
DEBUG 		= @DEBUG@
OPTIMIZE	= @OPTIMIZE@
CPPFLAGS	= -I$(SRCDIR) -I$(SRCDIR)/servlib @CPPFLAGS@
WARN  		= -Wall -Werror @OPTIMIZE_WARN@
CFLAGS		= $(CPPFLAGS) $(DEBUG) $(OPTIMIZE) $(DEPFLAGS) $(WARN)
LDFLAGS		= @LDFLAGS@
LIBS		= @LIBS@

#
# Add a phony rule to make sure this isn't created before the default
#
.PHONY: catchdefault
catchdefault:
	@echo "Rules.make should be included after the default rule is set"
	@exit 1

#
# Rule for generating a .o file from the corresponding .cc file;
# automatically creates dependencies via the -MMD flag.
#
%.o: %.cc
	@rm -f $@; mkdir -p $(@D)
	$(CXX) $(CFLAGS) -c $< -o $@

%.o: %.c
	@rm -f $@; mkdir -p $(@D)
	$(CC) $(CFLAGS) -c $< -o $@

#
# Generate cpp output in .E files.
#
%.E: %.cc
	@rm -f $@; mkdir -p $(@D)
	$(CXX) $(CFLAGS) -c $< -E -o $@

%.E: %.c
	@rm -f $@; mkdir -p $(@D)
	$(CXX) $(CFLAGS) -c $< -E -o $@

#
# Always include all the .d files that we can find, based on all the
# source files we can find.
#
ifeq ($(ALLSRCS),)
ALLSRCS := $(shell find . -name \*.cc -o -name \*.c)
endif
DEPFILES := $(ALLSRCS:%.cc=%.d)
DEPFILES := $(DEPFILES:%.c=%.d)
ifneq ($(DEPFILES),)
-include $(DEPFILES)
endif

echosrcdir:
	@echo "srcdir: $(SRCDIR)"

echodep:
	@echo "allsrcs: $(ALLSRCS)"
	@echo "depfiles: $(DEPFILES)"

#
# Clean out all object files
#
clean: $(SUBDIRS) objclean depclean genclean binclean

.PHONY: $(SUBDIRS)
$(SUBDIRS):
	$(MAKE) -w -C $@ $(MAKECMDGOALS)

.PHONY: objclean
objclean:
	@echo "removing object files..."
	find . \( -name '*.[Eo]' \) -print | xargs rm -f

.PHONY: depclean
depclean:
	@echo "removing dependency files..."
	find . \( -name '*.d' \) -print | xargs rm -f

.PHONY: genclean
genclean:
	@echo "removing generated files: $(GENFILES)..."
	@test -z "$(GENFILES)" || rm -f $(GENFILES)

.PHONY: binclean
binclean:
	@echo "removing binary files: $(BINFILES)..."
	@test -z "$(BINFILES)" || rm -f $(BINFILES)

.PHONY: distclean
CFGFILES := Rules.make config.h config.h config.cache
distclean: clean
	@echo "removing configure generated files: $(CFGFILES)..."
	@test -z "$(CFGFILES)" || rm -f $(CFGFILES)
