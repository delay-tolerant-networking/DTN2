#!/bin/sh
#
# IMPORTANT:  READ BEFORE DOWNLOADING, COPYING, INSTALLING OR USING.
# By downloading, copying, installing or using the software you agree to this 
# license.  If you do not agree to this license, do not download, install,
# copy or use the software.
#
# Copyright (c) 2003, The MITRE Corporation
# All rights reserved.
# 
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are 
# met:
# 
# Redistributions of source code must retain the above copyright notice,
# this list of conditions and the following disclaimer.  Redistributions 
# in binary form must reproduce the above copyright notice, this list of 
# conditions and the following disclaimer in the documentation and/or 
# other materials provided with the distribution.
# 
# Neither the name of The MITRE Corporation nor the names of its 
# contributors may be used to endorse or promote products derived from 
# this software without specific prior written permission.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS 
# IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
# THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR 
# CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, 
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, 
# PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR 
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
# LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING 
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS 
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
# 
# $Id$
#

##############
#
# CFLAGS
##############
#
#

#########
#
# TARGET
#########
#
# native
# 
# cerfcube (or arm)
#

target=native

exec_prefix='/usr/local/DTN'
bindir='${exec_prefix}/bin'
sbindir='${exec_prefix}/sbin'
libdir='${exec_prefix}/lib'
idir='${exec_prefix}/include'
mandir='/usr/local/man/manl'
static=''
allstatic=''

#
# Defaults
#
make_static='n'
debug='-g'
optimize='-O'
optimizewarn='-Wuninitialized' # depends on -O

#
# Libraries
#
staticlibs=''
libs='-lpthread'

tcldir=''
tclincdir=''
tcllibdir=''
tcllib=''

dbdir=''
dbincdir=''
dblibdir=''
dblib=''


pgdir=''
pgincdir=''
pglibdir=''
pglib=''




# End of user configurable options

ac_prev=
for ac_option
do
  if  test -n "$ac_prev"; then
      eval "$ac_prev=\$ac_option"
      ac_prev=
      continue
  fi

  case "$ac_option" in
  -*=*) ac_optarg=`echo "$ac_option" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
  *) ac_optarg= ;;
  esac

  case "$ac_option" in

  -target | --target | -t)
    ac_prev=target ;;
  -target=* | --target=* | -t=*)
    target="$ac_optarg" ;;

  -static | --static)
    make_static=y ;;
  -dynamic | --dynamic)
    make_static=n ;;

  -exec-prefix | --exec-prefix | -ep)
    ac_prev=exec_prefix ;;
  -exec-prefix=* | --exec-prefix=* | -ep=*)
    exec_prefix="$ac_optarg" ;;

  -mandir | --mandir | -md)
    ac_prev=mandir ;;
  -mandir=* | --mandir=* | -md=*)
    mandir="$ac_optarg" ;;

  -enable-debug | --enable-debug)
    debug='-g' ;;
  -disable-debug | --disable-debug)
    debug='' ;;

  -enable-optimize | --enable-optimize)
    ;; # no-op (is default)
  -disable-optimize | --disable-optimize)
    optimize='' 
    optimizewarn=''
    ;;

  -with-tcl | --with-tcl)
    ac_prev=with-tcl ;;
  -with-tcl=* | --with-tcl=*)
    tcldir="$ac_optarg" ;;

  -with-db | --with-db)
    ac_prev=with-db ;;
  -with-db=* | --with-db=*)
    dbdir="$ac_optarg" ;;


  -with-pg | --with-pg)
    ac_prev=with-pg ;;
  -with-pg=* | --with-pg=*)
    pgdir="$ac_optarg" ;;


  -help | --help | -h)
    cat <<EOF
Usage: configure [options]
Options [defaults in brackets after descriptions]
Directory and file names:
  --exec-prefix=EPREFIX           install architecture-independent files in PREFIX
                                  [$exec_prefix]
  --target=TARGET                 Configure for TARGET.  Valid targets are 'native'
                                  and 'arm' [$target]
  --static                        Build static objects; do not use dynamic link libraries
  --mandir=MANUAL_DIR             Install man pages here [$mandir]
Features
     debug			  Include '-g' in the CFLAGS.
     optimize			  Include '-O' in the CFLAGS.

  --disable-FEATURE
  --enable-FEATURE[=ARG]
Packages
  --with-db=DIR			  Location of a Berkeley DB installation (or none)
  --with-pg=DIR			  Location of a Postgres  installation (or none)
  --with-tcl=DIR		  Location of a tcl installation (default system)
EOF
  exit 0
  ;;
  *)
    cat <<EOF
configure: unrecognized option \`$ac_option'.
Try \`configure --help' for more information.
EOF
  exit 1
  ;;
  esac
done

case "$make_static" in
    yes | y | true | t)
    static="-static"
    allstatic="-all-static"
    libext=a
    ;;

    *)
    libext=so
    ;;
esac

#
# Find the tcl library
#
if [ ! "$tcldir" = "" ]; then
  #
  # Make sure the directory the user specified is ok
  #
  if [ -f $tcldir/include/tcl.h ]; then
	tclincdir=-I$tcldir
  else
	echo "can't find tcl.h in $tcldir"
	exit 1
  fi

  if   [ -f $tcldir/libtcl.$libext ]; then
	tcllibdir=-L$tcldir
	tcllib=-ltcl
  elif [ -f $tcldir/libtcl8.3.$libext ]; then
	tcllibdir=-L$tcldir
	tcllib=-ltcl8.3
  else
	echo "can't find libtcl.$libext or libtcl8.3.$libext in $tcldir"
	exit 1
  fi

else
  #
  # Try to find a system installation
  #
  if [ -f /usr/include/tcl.h ]; then
	tclincdir=
  elif [ -f /usr/include/tcl8.3/tcl.h ]; then
	tclincdir=-I/usr/include/tcl8.3
  else
	echo "can't find usable tcl.h"
	exit 1
  fi

  if   [ -f /usr/lib/libtcl.$libext ]; then
	tcllib=-ltcl
  elif [ -f /usr/lib/libtcl8.3.$libext ]; then
	tcllib=-ltcl8.3
  else
	echo "can't find usable libtcl.$libext"
	exit 1
  fi
fi

#
# Find the berkeley db library
#
if [ "$dbdir" = "none" ]; then
  # XXX/demmer do something
  exit 1
else
  #
  # check the supplied (or system) directory
  #
  if [ "$dbdir" = "" ]; then
	dbdir=/usr
  fi

  if   [ ! -f $dbdir/include/db.h ] ; then
	echo "can't find db.h in $dbdir"
  	exit 1
  elif   [ ! -f $dbdir/include/db_cxx.h ] ; then
	echo "can't find db_cxx.h in $dbdir"
  	exit 1
  else
	dbincdir=-I$dbdir/include
  fi

  if   [ ! -f $dbdir/lib/libdb.$libext ] ; then
	echo "can't find libdb.$libext in $dbdir"
  	exit 1
  elif [ ! -f $dbdir/lib/libdb_cxx.$libext ] ; then
	echo "can't find libdb_cxx.$libext in $dbdir"
  	exit 1
  else
	dblibdir=-L$dbdir/lib
	dblib="-ldb -ldb_cxx"
  fi
fi

if [ $target == "arm" -o $target == "cerfcube" -o $target == "arm+apps" ]; then
	exec_prefix=`pwd`/Stage
	bindir='${exec_prefix}/bin'
	sbindir='${exec_prefix}/sbin'
	libdir='${exec_prefix}/lib'
	mandir='${exec_prefix}/man/manl'
	idir='${exec_prefix}/include'
	cflags='-g -Wall -DUSE_DB -DDB_PKG_SLEEPYCAT_$db_version -D_REENTRANT'
fi



#
# Find the postgres dlibrary
#
if [ "$pgdir" = "none" ]; then
  # XXX/demmer do something
  exit 1
else
  #
  # check the supplied (or system) directory
  #
  if [ "$pgdir" = "" ]; then
	pgdir=/usr/local/pgsql
  fi

  pgincdir=$pgdir/include/server
  if   [ ! -f $pgincdir/libpq++.h ] ; then
	echo "can't find libpq++.h in $pgincdir"
  	exit 1
  else
      pgincdir=-I$pgincdir
  fi


  pglibdir=$pgdir/lib
  if   [ ! -f $pglibdir/libpq++.$libext ] ; then
	echo "can't find libpq++.$libext in $pglibdir"
  	exit 1
  else
	pglibdir=-L$pglibdir
	pglib="-lpq++"
  fi
fi


echo "Options:"
echo "  TARGET is: $target"
echo "  Debug: $debug"
echo "  Optimize: $optimize"
echo "  Static: $make_static"
echo " "
echo "Directories"
echo "  exec_prefix: $exec_prefix"
echo "  bindir:  $bindir"
echo "  sbindir: $sbindir"
echo "  libdir:  $libdir"
echo "  mandir:  $mandir"
echo "  incdir:  $incdir"
echo " "
echo "Packages"
echo "  tcl: $tclincdir $tcllibdir $tcllib"
echo "  db: $dbincdir $dblibdir $dblib"
echo "  pg: $pgincdir $pglibdir $pglib"

echo "#" > Rules.make
echo "# This file was automatically generated by configure; do not edit directly" > Rules.make
sed -e "
s%@EXEC_PREFIX@%$exec_prefix%g
s%@CFLAGS@%$cflags%g
s%@BINDIR@%$bindir%g
s%@SBINDIR@%$sbindir%g
s%@LIBDIR@%$libdir%g
s%@MANDIR@%$mandir%g
s%@INCDIR@%$incdir%g
s%@TARGET@%$target%g
s%@STATIC@%$static%g
s%@ALLSTATIC@%$allstatic%g
s%@DEBUG@%$debug%g
s%@OPTIMIZE@%$optimize%g
s%@OPTIMIZE_WARN@%$optimizewarn%g
s%@TCL_INCDIR@%$tclincdir%g
s%@TCL_LIBDIR@%$tcllibdir%g
s%@TCL_LIB@%$tcllib%g
s%@DB_INCDIR@%$dbincdir%g
s%@DB_LIBDIR@%$dblibdir%g
s%@DB_LIB@%$dblib%g
s%@PG_INCDIR@%$pgincdir%g
s%@PG_LIBDIR@%$pglibdir%g
s%@PG_LIB@%$pglib%g
s%@LIBS@%$libs%g
s%@STATIC_LIBS@%$static_libs%g

" Rules.make.in >> Rules.make

echo ""
echo "wrote Rules.make; now run make"
