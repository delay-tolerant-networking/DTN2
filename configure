#!/bin/sh
#
# IMPORTANT:  READ BEFORE DOWNLOADING, COPYING, INSTALLING OR USING.
# By downloading, copying, installing or using the software you agree to this 
# license.  If you do not agree to this license, do not download, install,
# copy or use the software.
#
# Copyright (c) 2003, The MITRE Corporation
# All rights reserved.
# 
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are 
# met:
# 
# Redistributions of source code must retain the above copyright notice,
# this list of conditions and the following disclaimer.  Redistributions 
# in binary form must reproduce the above copyright notice, this list of 
# conditions and the following disclaimer in the documentation and/or 
# other materials provided with the distribution.
# 
# Neither the name of The MITRE Corporation nor the names of its 
# contributors may be used to endorse or promote products derived from 
# this software without specific prior written permission.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS 
# IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
# THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR 
# CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, 
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, 
# PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR 
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
# LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING 
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS 
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
# 
# $Id$
#

#
# Before anything else, check for configure --verbose
#
for ac_option do
   case "$ac_option" in
   -verbose | --verbose | -v)
      set -x
      break
      ;;
   esac
done

##############
#
# CFLAGS
##############
#
#

#########
#
# TARGET
#########
#
# native
# 
# cerfcube (or arm)
#

target=native

exec_prefix='/usr/local/DTN'
bindir='${exec_prefix}/bin'
sbindir='${exec_prefix}/sbin'
libdir='${exec_prefix}/lib'
idir='${exec_prefix}/include'
mandir='/usr/local/man/manl'
static=''
allstatic=''

#
# Defaults
#
make_static='n'
debug='-g'
# optimize='-O'
# optimizewarn='-Wuninitialized' # depends on -O
optimize=''
optimizewarn=''

#
# Libraries
#
staticlibs=''
libs='-lpthread'

tcldir=''
tclincdir=''
tcllibdir=''
tcllib=''

dbdir=''
dbincdir=''
dblibdir=''
dblib=''


postgresdir=''
postgresincdir=''
postgreslibdir=''
postgreslib=''




# End of user configurable options

ac_prev=
for ac_option
do
  if  test -n "$ac_prev"; then
      eval "$ac_prev=\$ac_option"
      ac_prev=
      continue
  fi

  case "$ac_option" in
  -*=*) ac_optarg=`echo "$ac_option" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
  *) ac_optarg= ;;
  esac

  case "$ac_option" in
  -verbose | --verbose | -v)
     ;;
  -target | --target | -t)
    ac_prev=target ;;
  -target=* | --target=* | -t=*)
    target="$ac_optarg" ;;

  -static | --static)
    make_static=y ;;
  -dynamic | --dynamic)
    make_static=n ;;

  -exec-prefix | --exec-prefix | -ep)
    ac_prev=exec_prefix ;;
  -exec-prefix=* | --exec-prefix=* | -ep=*)
    exec_prefix="$ac_optarg" ;;

  -mandir | --mandir | -md)
    ac_prev=mandir ;;
  -mandir=* | --mandir=* | -md=*)
    mandir="$ac_optarg" ;;

  -enable-debug | --enable-debug)
    debug='-g' ;;
  -disable-debug | --disable-debug)
    debug='' ;;

  -enable-optimize | --enable-optimize)
    optimize='-O'
    optimizewarn='-Wuninitialized'
    ;;
  -disable-optimize | --disable-optimize)
    optimize='' 
    optimizewarn=''
    ;;

  -with-tcl | --with-tcl)
    ac_prev=with-tcl ;;
  -with-tcl=* | --with-tcl=*)
    tcldir="$ac_optarg" ;;

  -with-db | --with-db)
    ac_prev=with-db ;;
  -with-db=* | --with-db=*)
    dbdir="$ac_optarg" ;;

  -with-postgres | --with-postgres)
    ac_prev=with-postgres ;;
  -with-postgres=* | --with-postgres=*)
    postgresdir="$ac_optarg" ;;

  -help | --help | -h)
    cat <<EOF
Usage: configure [options]
Options [defaults in brackets after descriptions]
Directory and file names:
  --exec-prefix=EPREFIX           install architecture-independent files in PREFIX
                                  [$exec_prefix]
  --target=TARGET                 Configure for TARGET.  Valid targets are 'native'
                                  and 'arm' [$target]
  --static                        Build static objects; do not use dynamic link libraries
  --mandir=MANUAL_DIR             Install man pages here [$mandir]
Features
     debug			  Include '-g' in the CFLAGS.
     optimize			  Include '-O' in the CFLAGS.

  --disable-FEATURE
  --enable-FEATURE[=ARG]
Packages
  --with-db=DIR			  Location of a Berkeley DB installation (or none)
  --with-postgres=DIR			  Location of a Postgres  installation (or none)
  --with-tcl=DIR		  Location of a tcl installation (default system)
EOF
  exit 0
  ;;
  *)
    cat <<EOF
configure: unrecognized option \`$ac_option'.
Try \`configure --help' for more information.
EOF
  exit 1
  ;;
  esac
done

case "$make_static" in
    yes | y | true | t)
    static="-static"
    allstatic="-all-static"
    libext=a
    ;;

    *)
    libext=so
    ;;
esac

#
# Find the tcl library
#
if [ ! "$tcldir" = "" ]; then
  #
  # Make sure the directory the user specified is ok
  #
  if [ -r $tcldir/include/tcl.h ]; then
	tclincdir=-I$tcldir
  else
	echo "can't find tcl.h in $tcldir"
	exit 1
  fi

  if   [ -r $tcldir/libtcl.$libext ]; then
	tcllibdir=-L$tcldir
	tcllib=-ltcl
  elif [ -r $tcldir/libtcl8.3.$libext ]; then
	tcllibdir=-L$tcldir
	tcllib=-ltcl8.3
  else
	echo "can't find libtcl.$libext or libtcl8.3.$libext in $tcldir"
	exit 1
  fi

else
  #
  # Try to find a system installation
  #
  if [ -r /usr/include/tcl.h ]; then
	tclincdir=
  elif [ -r /usr/include/tcl8.3/tcl.h ]; then
	tclincdir=-I/usr/include/tcl8.3
  else
	echo "can't find usable tcl.h"
	exit 1
  fi

  if   [ -r /usr/lib/libtcl.$libext ]; then
	tcllib=-ltcl
  elif [ -r /usr/lib/libtcl8.3.$libext ]; then
	tcllib=-ltcl8.3
  else
	echo "can't find usable libtcl.$libext"
	exit 1
  fi
fi

#
# Find the berkeley db library
#
if [ "$dbdir" = "none" ]; then
  # XXX/demmer do something
  exit 1
else
  #
  # check the supplied (or system) directory
  #
  if [ "$dbdir" = "" ]; then
	dbdir=/usr
  fi

  if   [ ! -r $dbdir/include/db.h ] ; then
	echo "can't find db.h in $dbdir/include"
  	exit 1
  elif   [ ! -r $dbdir/include/db_cxx.h ] ; then
	echo "can't find db_cxx.h in $dbdir/include"
  	exit 1
  else
	dbincdir=-I$dbdir/include
  fi

  if   [ ! -r $dbdir/lib/libdb.$libext ] ; then
	echo "can't find libdb.$libext in $dbdir"
  	exit 1
  elif [ ! -r $dbdir/lib/libdb_cxx.$libext ] ; then
	echo "can't find libdb_cxx.$libext in $dbdir"
  	exit 1
  else
	dblibdir=-L$dbdir/lib
	dblib="-ldb -ldb_cxx"
  fi
fi

if [ $target == "arm" -o $target == "cerfcube" -o $target == "arm+apps" ]; then
	exec_prefix=`pwd`/Stage
	bindir='${exec_prefix}/bin'
	sbindir='${exec_prefix}/sbin'
	libdir='${exec_prefix}/lib'
	mandir='${exec_prefix}/man/manl'
	idir='${exec_prefix}/include'
	cflags='-g -Wall -DUSE_DB -DDB_PKG_SLEEPYCAT_$db_version -D_REENTRANT'
fi



#
# Find the postgres dlibrary
#
#
# XXX/demmer fix me later
postgresdir=none
if [ "$postgresdir" = "none" ]; then
       	echo "Warning: need to find postgres library"
#  exit 1
else
  if [ ! "$postgresdir" = "" ]; then
	  #
	  # check the supplied directory
	  #
	  postgresincdir=$postgresdir/include/server
	  if   [ ! -r $postgresincdir/libpq++.h ] ; then
		echo "can't find libpq++.h in $postgresincdir"
	  	exit 1
	  else
	      postgresincdir=-I$postgresincdir
	  fi

	  postgreslibdir=$postgresdir/lib
	  if   [ ! -r $postgreslibdir/libpq++.$libext ] ; then
		echo "can't find libpq++.$libext in $postgreslibdir"
	  	exit 1
	  else
		postgreslibdir=-L$postgreslibdir
		postgreslib="-lpq++"
	  fi
   else
	#
	# try to find a system installation
	#
	if   [ -r /usr/include/postgresql/libpq++.h ]; then
		postgresincdir=-I/usr/include/postgresql

	elif [ -r /usr/local/pgsql/include/libpq++.h ]; then
		postgresincdir=-I/usr/local/pgsql/include

	else
		echo "can't find libpq++.h"
		exit 1
	fi

 	if   [ -r /usr/lib/libpq++.$libext ]; then
 		postgreslibdir=
 	elif [ -r /usr/local/pgsql/lib/libpq++.$libext ]; then
 		postgreslibdir=-L/usr/local/pgsql/lib
 	else
 		echo "can't find libpq++.$libext"
 		exit 1
 	fi
   fi
fi
		
echo "Options:"
echo "  TARGET is: $target"
echo "  Debug: $debug"
echo "  Optimize: $optimize"
echo "  Static: $make_static"
echo " "
echo "Directories"
echo "  exec_prefix: $exec_prefix"
echo "  bindir:  $bindir"
echo "  sbindir: $sbindir"
echo "  libdir:  $libdir"
echo "  mandir:  $mandir"
echo "  incdir:  $incdir"
echo " "
echo "Packages"
echo "  tcl: $tclincdir $tcllibdir $tcllib"
echo "  db: $dbincdir $dblibdir $dblib"
echo "  postgres: $postgresincdir $postgreslibdir $postgreslib"

echo "#" > Rules.make
echo "# This file was automatically generated by configure; do not edit directly" > Rules.make
sed -e "
s%@EXEC_PREFIX@%$exec_prefix%g
s%@CFLAGS@%$cflags%g
s%@BINDIR@%$bindir%g
s%@SBINDIR@%$sbindir%g
s%@LIBDIR@%$libdir%g
s%@MANDIR@%$mandir%g
s%@INCDIR@%$incdir%g
s%@TARGET@%$target%g
s%@STATIC@%$static%g
s%@ALLSTATIC@%$allstatic%g
s%@DEBUG@%$debug%g
s%@OPTIMIZE@%$optimize%g
s%@OPTIMIZE_WARN@%$optimizewarn%g
s%@TCL_INCDIR@%$tclincdir%g
s%@TCL_LIBDIR@%$tcllibdir%g
s%@TCL_LIB@%$tcllib%g
s%@DB_INCDIR@%$dbincdir%g
s%@DB_LIBDIR@%$dblibdir%g
s%@DB_LIB@%$dblib%g
s%@POSTGRES_INCDIR@%$postgresincdir%g
s%@POSTGRES_LIBDIR@%$postgreslibdir%g
s%@POSTGRES_LIB@%$postgreslib%g
s%@LIBS@%$libs%g
s%@STATIC_LIBS@%$static_libs%g

" Rules.make.in >> Rules.make

echo ""
echo "wrote Rules.make; now run make"
